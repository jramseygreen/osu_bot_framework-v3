<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8"/>
    <title>OBF3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
<div id="app" class="container-fluid">
    <!--    sidebar-->
    <div class="row">
        <div class="col d-flex flex-column text-white bg-dark" style="height: 100vh;">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <div class="row">
                    <div class="col-3">
                        <img src="https://cdn.discordapp.com/attachments/904455843813154837/909234894331334696/dunnoO-blue.png"
                             width="50" height="50">
                    </div>
                    <div class="col-9">
                        <h3 class="text-center">OBF-3</h3>
                    </div>
                </div>
            </a>
            <hr>
            <span class="fs-4 mb-2">Channels</span>
            <ul class="nav nav-pills flex-column mb-auto" id="channels">
                <li v-for="channel in channels" class="nav-item">
                    <a :href="channel" class="nav-link" aria-current="page" onclick="setChannel(this)">
                        <svg class="bi me-2" width="16" height="16"></svg>
                        <span class="text-light">{{channel}}
                        <span class="badge rounded-pill bg-light text-dark">{{userNum}}
                        </span>
                        </span>
                    </a>
                </li>
            </ul>
            <hr>
            <!-- Button trigger modal -->
            <button class="nav-link text-white text-center rounded-pill bg-secondary" data-bs-toggle="modal"
                    data-bs-target="#personalMessages">
                Personal Messages
            </button>

            <!-- Modal -->
            <div class="modal fade" id="personalMessages" tabindex="-1" role="dialog"
                 aria-labelledby="#personalMessagesLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body text-dark">
                            <div class="card text-white bg-secondary text-center">
                                <h3 class="card-title">Personal Messages</h3>
                                <hr>
                                <div class="container">
                                    <div class="card text-white bg-dark">
                                        <div style="overflow-y: scroll; height: 50vh;">
                                            <table class="table text-white">
                                                <thead>
                                                <tr>
                                                    <th>From</th>
                                                    <th>To</th>
                                                    <th>Message</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr v-for="message in personal_messages">
                                                    <th scope="row">{{message.username}}</th>
                                                    <th>{{message.channel}}</th>
                                                    <td style="max-width: 100%;">{{message.content}}</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <!--                                    input section-->
                                    <div class="card mb-4">
                                        <form>
                                            <div class="input-group mt-1 mb-1">
                                                <input type="text" class="form-control"
                                                       placeholder="Username" style="max-width: 15%;" id="pm_username">
                                                <input type="text" class="form-control"
                                                       placeholder="Say something..." id="personal_message">
                                                <button class="btn btn-dark" type="submit"
                                                        onclick="send_message('personal_message', document.getElementById('pm_username').value)">Send
                                                </button>
                                            </div>
                                        </form>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close
                            </button>
                            <button type="button" class="btn btn-primary">Create</button>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <!-- make room -->
            <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#makeRoom">
                Make Room
            </button>

            <!-- make room Modal -->
            <div class="modal fade" id="makeRoom" tabindex="-1" role="dialog"
                 aria-labelledby="#makeRoomLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-dark" id="makeRoomLabel">Make a new game room</h5>
                            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <!--                        modal body-->
                        <form id="make_room_form">
                            <div class="mb-3">
                                <h5 class="text-dark">Room Title</h5>
                                <input type="text" class="form-control" id="make_room_title">
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close
                                </button>
                                <button type="button" class="btn btn-primary" onclick="make_room(this.form)">Create
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- join channel -->
            <button type="button" class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#joinChannel">
                Join Channel
            </button>

            <!-- join channel Modal -->
            <div class="modal fade" id="joinChannel" tabindex="-1" role="dialog"
                 aria-labelledby="#joinChannelLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-dark" id="joinChannelLabel">Join a channel</h5>
                            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <!--                        modal body-->
                        <div class="modal-body text-dark">

                            <form id="join_channel_form">
                                <div class="mb-3">
                                    <h5 class="text-dark">Channel to join</h5>
                                    <input type="text" class="form-control" id="join_form_channel">
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="join_channel(this.form)">
                                        Join
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--        main content-->
        <div class="col-10">
            <div class="card text-white bg-dark" style="height: 100vh;">
                <h2 class="card-header text-center">
                    {{channel}}
                </h2>
                <span class="badge bg-success">{{inProgress}}</span>
                <hr>
                <!--                limits and ranges-->
                <div class="container card-body text-center">
                    <div class="row">
                        <div class="col-1 card bg-secondary">
                            AR range
                            min
                            <input type="range" class="form-range" min="0" max="10" step="1" id="arRangeMin">
                            max
                            <input type="range" class="form-range" min="0" max="10" step="1" id="arRangeMax">
                        </div>
                        <div class="col-1 card bg-secondary">
                            OD range
                        </div>
                        <div class="col-1 card bg-secondary">
                            CS range
                        </div>
                        <div class="col-1 card bg-secondary">
                            HP range
                        </div>
                        <div class="col-1 card bg-secondary">
                            BPM range
                        </div>
                        <div class="col-1 card bg-secondary">
                            Length range
                        </div>
                        <div class="col-1 card bg-secondary">
                            Difficulty range
                        </div>
                        <div class="col-1 card bg-secondary">
                            Game Mode
                        </div>
                        <div class="col-1 card bg-secondary">
                            Mods
                        </div>
                        <div class="col-1 card bg-secondary">
                            Scoring Type
                        </div>
                        <div class="col-1 card bg-secondary">
                            Team Type
                        </div>
                        <div class="col-1 card bg-secondary">
                            Map Status
                        </div>
                    </div>
                </div>
                <div class="container">
                    <div class="row">
                        <!--                    players-->
                        <div class="col-3">
                            <div class="card text-white bg-secondary">
                                <h3 class="text-center mt-2">Players<span
                                        class="card-header badge ms-4 bg-light text-dark">{{userNum}}</span>
                                </h3>
                                <hr>

                                <div style="overflow-y: scroll; height: 59vh">
                                    <table class="table table-sm text-white">
                                        <thead>
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Username</th>
                                            <th scope="col">Badges</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <template>
                                            <tr v-for="(slot, index) in slots">
                                                <th scope="row">{{parseInt(index) + 1}}</th>
                                                <td>{{slot.username}}</td>
                                                <td>{{slot.badges}}</td>
                                            </tr>
                                        </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!--                    chat-->
                        <div class="col-7">
                            <div class="card text-white bg-secondary text-center">
                                <h3 class="card-title">Chat</h3>
                                <hr>
                                <div class="container">
                                    <div class="card text-white bg-dark">
                                        <div style="overflow-y: scroll; height: 50vh;">
                                            <table id="chat" class="table text-white">
                                                <tbody>
                                                <tr v-for="message in messages">
                                                    <th scope="row">{{message.username}}</th>
                                                    <td style="max-width: 100%;">{{message.content}}</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <!--                                    input section-->
                                    <div class="card mb-4">
                                        <form>
                                            <div class="input-group mt-1 mb-1">
                                                <input id="channel_message" type="text" class="form-control"
                                                       placeholder="Say something...">
                                                <button class="btn btn-dark" type="submit"
                                                        onclick="send_message('channel_message', app.channel)">Send
                                                </button>
                                            </div>
                                        </form>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="col-2">
                            <!--                        beatmap-->
                            <div class="card bg-secondary mb-4">
                                <h3 class="card-header text-center">Beatmap</h3>
                                <a :href="beatmap.url" target="_blank" style="text-decoration: none;">
                                    <h5 class="text-center text-light mt-2">{{beatmapName}}</h5>
                                    <hr>
                                    <img :src="beatmapImage"
                                         class="rounded"
                                         alt="..."
                                         width="190">
                                </a>
                                <hr>
                                <div class="mb-3">
                                    <span class="badge rounded-pill bg-info text-dark">{{beatmap.difficulty_rating}} â˜…</span>
                                    <span class="badge rounded-pill bg-info text-dark">{{beatmap.hit_length}} sec</span>
                                    <span class="badge rounded-pill bg-info text-dark">{{beatmap.mode}}</span>
                                    <span class="badge rounded-pill bg-info text-dark">{{beatmap.status}}</span>
                                    <span class="badge rounded-pill bg-info text-dark">{{beatmap.bpm}} BPM</span>
                                    <span class="badge rounded-pill bg-info text-dark">AR {{beatmap.ar}}</span>
                                    <span class="badge rounded-pill bg-info text-dark">OD {{beatmap.accuracy}}</span>
                                    <span class="badge rounded-pill bg-info text-dark">CS {{beatmap.cs}}</span>
                                    <span class="badge rounded-pill bg-info text-dark">HP {{beatmap.drain}}</span>
                                </div>
                            </div>
                            <div class="card bg-secondary">
                                <!--                            buttons-->
                                <div class="dropdown text-center">
                                    <h6>Logic Profile</h6>
                                    <button class="btn btn-secondary dropdown-toggle" type="button"
                                            id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="badge bg-secondary">{{logic_profile}}</span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="logicProfiles">
                                        <li><a class="dropdown-item" href="#">AutoHostRotate</a></li>
                                        <li><a class="dropdown-item" href="#">KingOfTheHill</a></li>
                                        <li><a class="dropdown-item" href="#">Something else here</a></li>
                                    </ul>
                                </div>
                                <hr>
                                <table class="table">
                                    <tbody>
                                    <tr>
                                        <td>
                                            <button type="button" class="btn btn-success" onclick="start_match()">Start
                                                Match
                                            </button>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger" onclick="abort_match()">Abort
                                                Match
                                            </button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                                <button type="button" class="btn rounded-pill btn-warning text-secondary mb-3">Advanced
                                    Options
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script>
    var sock = new WebSocket("ws://localhost:9876/");
    var buffer;
    var app;
    window.onload = function () {
        sock.onopen = function () {
            sock.send(JSON.stringify({"command": "update"}));
        };

        sock.onclose = function () {
            var new_sock = new WebSocket("ws://localhost:9876/");
            new_sock.onopen = function () {
                sock = new_sock;
            };
        };

        sock.onerror = function (error) {
            console.log('WebSocket Error ' + error);
        };

        sock.onmessage = function (e) {
            console.log('Server: ' + e.data);
            buffer = JSON.parse(e.data);
            app.channels = Object.keys(buffer["channels"]);
            app.personal_messages = buffer["pm"];
            if (app.channel !== "" && app.channels.includes(app.channel)) {
                app.logic_profile = buffer["channels"][app.channel]["logic_profile"];
                app.slots = buffer["channels"][app.channel]["slots"];
                app.messages = buffer["channels"][app.channel]["messages"];
                app.users = buffer["channels"][app.channel]["users"];
                app.userNum = buffer["channels"][app.channel]["users"].length;
                if (app.channel.includes("#mp_")) {
                    app.host = buffer["channels"][app.channel]["host"];
                    app.inProgress = (buffer["channels"][app.channel]["in_progress"] ? "In Progress..." : "");
                    app.beatmap = buffer["channels"][app.channel]["beatmap"];
                    app.beatmapName = buffer["channels"][app.channel]["beatmap_name"]
                    app.beatmapImage = "https://assets.ppy.sh/beatmaps/" + buffer["channels"][app.channel]["beatmap"]["beatmapset_id"] + "/covers/card.jpg";
                }

            }
        };
    };

    app = new Vue({
        el: "#app",
        data: {
            channel: "",
            logic_profile: "",
            slots: {},
            users: [],
            userNum: 0,
            host: "",
            channels: [],
            inProgress: "",
            messages: [],
            beatmap: {},
            beatmapName: "",
            beatmapImage: "",
            personal_messages: [],
        }
    })

    function setChannel(data) {
        app.channel = data.getAttribute("href");
        var ul = document.getElementById("channels");
        var items = ul.getElementsByTagName("li");
        for (var i = 0; i < items.length; ++i) {
            // do something with items[i], which is a <li> element
            items[i].firstElementChild.classList.remove("active");
        }
        data.classList.add("active")
        sock.send(JSON.stringify({"command": "update"}));
    }

    function start_match() {
        payload = {
            "command": "start_match",
            "channel": app.channel
        };
        sock.send(JSON.stringify(payload));
    }

    function abort_match() {
        payload = {
            "command": "abort_match",
            "channel": app.channel
        };
        sock.send(JSON.stringify(payload));
    }

    function make_room(form) {
        payload = {
            "command": "make_room",
            "title": form.elements.make_room_title.value,
        };
        sock.send(JSON.stringify(payload));
        form.reset();
    }

    function join_channel(form) {
        payload = {
            "command": "join",
            "channel": form.elements.join_form_channel.value,
        };
        sock.send(JSON.stringify(payload));
        form.reset();
    }

    function send_message(inputObj, channel) {
        message = document.getElementById(inputObj).value;
        document.getElementById(inputObj).value = "";
        payload = {
            "command": inputObj,
            "channel": channel,
            "message": message
        };
        sock.send(JSON.stringify(payload));
    }
</script>

</body>
</html>
